services:
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.1
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - kafka
    ports:
      - 22181:2181

  kafka:
    image: confluentinc/cp-kafka:7.5.1
    container_name: kafka
    depends_on:
      - zookeeper
    ports:
      - 9092:9092
    networks:
      - kafka
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1

  eureka-server:
    build:
      context: eureka-server
      dockerfile: Dockerfile
    container_name: eureka-server
    ports:
      - 8761:8761
    restart: always
    networks:
      - discovery

  gateway:
    build:
      context: gateway
      dockerfile: Dockerfile
    container_name: gateway
    ports:
      - 8888:8888
    depends_on:
      - eureka-server
    restart: always
    networks:
      - discovery
      - gateway
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/

  gateway-cache:
    image: redis:7-alpine
    container_name: gateway-cache
    restart: always
    ports:
      - 6379:6379
    networks:
      - gateway
    deploy:
      resources:
        limits:
          memory: 512M

  passenger:
    build:
      context: passenger
      dockerfile: Dockerfile
    container_name: passenger
    depends_on:
      - eureka-server
      - passenger_db
      - kafka
    networks:
      - passenger
      - kafka
      - discovery
    ports:
      - 8080:8080
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - SPRING_DATASOURCE_URL=jdbc:postgresql://passenger_db:5432/passenger
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:9092

  passenger_db:
    image: postgres:15-alpine
    container_name: passenger_db
    restart: always
    networks:
      - passenger
    ports:
      - 5433:5432
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=passenger

  driver:
    build:
      context: driver
      dockerfile: Dockerfile
    container_name: driver
    depends_on:
      - driver_db
      - eureka-server
    networks:
      - driver
      - kafka
      - discovery
    ports:
      - 8081:8081
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - SPRING_DATASOURCE_URL=jdbc:postgresql://driver_db:5432/driver
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:9092

  driver_db:
    image: postgres:15-alpine
    container_name: driver_db
    restart: always
    networks:
      - driver
    ports:
      - 5434:5432
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=driver

  ride:
    build:
      context: ride
      dockerfile: Dockerfile
    container_name: ride
    depends_on:
      - ride_db
      - kafka
      - eureka-server
    networks:
      - ride
      - kafka
      - discovery
    ports:
      - 8082:8082
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - SPRING_DATA_MONGODB_HOST=ride_db
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - DRIVER_URL=driver:8081

  ride_db:
    image: mongo:7.0
    container_name: ride_db
    ports:
      - 27018:27017
    networks:
      - ride
    environment:
      - MONGO_INITDB_DATABASE=ride

  payment:
    build:
      context: payment
      dockerfile: Dockerfile
    container_name: payment
    depends_on:
      - payment_db
      - eureka-server
    networks:
      - payment
      - kafka
      - discovery
    ports:
      - 8083:8083
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - SPRING_DATASOURCE_URL=jdbc:postgresql://payment_db:5432/payment
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:9092

  payment_db:
    image: postgres:15-alpine
    container_name: payment_db
    restart: always
    networks:
      - payment
    ports:
      - 5435:5432
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=payment

  rating:
    build:
      context: rating
      dockerfile: Dockerfile
    container_name: rating
    depends_on:
      - rating_db
      - eureka-server
    networks:
      - rating
      - kafka
      - discovery
    ports:
      - 8084:8084
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - SPRING_DATASOURCE_URL=jdbc:postgresql://rating_db:5432/rating
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:9092

  rating_db:
    image: postgres:15-alpine
    container_name: rating_db
    restart: always
    networks:
      - rating
    ports:
      - 5436:5432
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=rating

  elasticsearch:
    image: elasticsearch:8.11.2
    container_name: elasticsearch
    ports:
      - 9200:9200
      - 9300:9300
    volumes:
     - ./elk/elasticsearch/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml:ro,Z
    restart: unless-stopped
    environment:
      node.name: elasticsearch
      discovery.type: single-node
      ES_JAVA_OPTS: -Xms512m -Xmx512m
    networks:
      - elk

  logstash:
    image: logstash:8.11.2
    container_name: logstash
    volumes:
      - ./elk/logstash/logstash.yml:/usr/share/logstash/config/logstash.yml:ro,Z
      - ./elk/logstash/logstash.conf:/usr/share/logstash/pipeline/logstash.conf:ro,Z
    ports:
      - 5400:5400
      - 50000:50000/tcp
      - 50000:50000/udp
      - 9600:9600
    networks:
      - elk
    depends_on:
      - elasticsearch

  kibana:
    image: kibana:8.11.2
    container_name: kibana
    volumes:
      - ./elk/kibana/kibana.yml:/usr/share/kibana/config/kibana.yml:ro
    ports:
      - 5601:5601
    networks:
      - elk
    depends_on:
      - elasticsearch

networks:
  elk:
  ride:
  kafka:
  driver:
  rating:
  gateway:
  payment:
  passenger:
  discovery:
